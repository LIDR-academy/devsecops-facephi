name: CD Pipeline

on:
  push:
    branches:
      - main
    tags:
      - "v*"

jobs:
  build_and_push_images:
    name: Build and push Docker images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker registry auth (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build backend image
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/facephi-secdevops-backend"
          docker build \
            -f backend/Dockerfile.dev \
            -t "${IMAGE_NAME}:${{ github.sha }}" \
            backend
          echo "BACKEND_IMAGE=${IMAGE_NAME}:${{ github.sha }}" >> $GITHUB_ENV

      - name: Build frontend image
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/facephi-secdevops-frontend"
          docker build \
            -f frontend/Dockerfile.dev \
            -t "${IMAGE_NAME}:${{ github.sha }}" \
            frontend
          echo "FRONTEND_IMAGE=${IMAGE_NAME}:${{ github.sha }}" >> $GITHUB_ENV

      - name: Push images to GHCR
        run: |
          docker push "$BACKEND_IMAGE"
          docker push "$FRONTEND_IMAGE"

  deploy_new_env:
    name: Deploy to new environment (stub)
    runs-on: ubuntu-latest
    needs: build_and_push_images
    permissions:
      contents: read

    steps:
      - name: Show built image references
        run: |
          echo "Backend image: $BACKEND_IMAGE"
          echo "Frontend image: $FRONTEND_IMAGE"

      - name: Placeholder for new infra deployment
        run: |
          echo "TODO: Implement deployment to new infrastructure (e.g. ECS/EKS/containers on EC2) using Terraform in tf/."
          echo "This job is intentionally left as a stub so you can connect it to your chosen target later."

