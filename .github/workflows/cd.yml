name: CD Pipeline

on:
  push:
    branches:
      - main
    tags:
      - "v*"

jobs:
  build_and_push_images:
    name: Build and push Docker images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker registry auth (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build backend image
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/facephi-secdevops-backend"
          docker build \
            -f backend/Dockerfile.dev \
            -t "${IMAGE_NAME}:${{ github.sha }}" \
            backend
          echo "BACKEND_IMAGE=${IMAGE_NAME}:${{ github.sha }}" >> $GITHUB_ENV

      - name: Build frontend image
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/facephi-secdevops-frontend"
          docker build \
            -f frontend/Dockerfile.dev \
            -t "${IMAGE_NAME}:${{ github.sha }}" \
            frontend
          echo "FRONTEND_IMAGE=${IMAGE_NAME}:${{ github.sha }}" >> $GITHUB_ENV

      # ── Container scanning: bloquea el deploy si la imagen tiene CVEs críticos ──
      - name: Trivy scan — backend image (SARIF)
        uses: aquasecurity/trivy-action@0.29.0
        with:
          image-ref: ${{ env.BACKEND_IMAGE }}
          format: "sarif"
          output: "trivy-backend-image.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "0"
          ignore-unfixed: true
          vuln-type: "library,os"

      - name: Upload backend image SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-backend-image.sarif
          category: trivy-backend-image

      - name: Trivy gate — backend image CRITICAL
        uses: aquasecurity/trivy-action@0.29.0
        with:
          image-ref: ${{ env.BACKEND_IMAGE }}
          format: "table"
          severity: "CRITICAL"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "library,os"

      - name: Trivy scan — frontend image (SARIF)
        uses: aquasecurity/trivy-action@0.29.0
        with:
          image-ref: ${{ env.FRONTEND_IMAGE }}
          format: "sarif"
          output: "trivy-frontend-image.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "0"
          ignore-unfixed: true
          vuln-type: "library,os"

      - name: Upload frontend image SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-frontend-image.sarif
          category: trivy-frontend-image

      - name: Trivy gate — frontend image CRITICAL
        uses: aquasecurity/trivy-action@0.29.0
        with:
          image-ref: ${{ env.FRONTEND_IMAGE }}
          format: "table"
          severity: "CRITICAL"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "library,os"

      - name: Push images to GHCR
        run: |
          docker push "$BACKEND_IMAGE"
          docker push "$FRONTEND_IMAGE"

  deploy_new_env:
    name: Deploy to new environment (stub)
    runs-on: ubuntu-latest
    needs: build_and_push_images
    permissions:
      contents: read

    steps:
      - name: Show built image references
        run: |
          echo "Backend image: $BACKEND_IMAGE"
          echo "Frontend image: $FRONTEND_IMAGE"

      - name: Placeholder for new infra deployment
        run: |
          echo "TODO: Implement deployment to new infrastructure (e.g. ECS/EKS/containers on EC2) using Terraform in tf/."
          echo "This job is intentionally left as a stub so you can connect it to your chosen target later."

